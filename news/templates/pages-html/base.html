<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="P1-wUN7Fx2j-RL3Xvaick8kfvMz4zmGrew5sPeRRFhs" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <title>{{title}}</title>
</head>
<body>
    <div class="body-base">
        {% include 'components/navbar.html' %}
        {% block agregate_news_info %}
        {% endblock %}
        {% if current_page != 1 %}
            {% include 'components/pagination.html' %}
        {% endif %}
        {% if current_page == 1 %}
            <div class="headers">{{title}}</div>
        {% endif %}
        {% block search_news %}{% endblock %}
        <main>
            <div class="cards">
            {% block body %}
            {% endblock %}
            </div>
            <div class="news-customer-analysis">
            {% block newsclient %}
            {% endblock %}
            </div>
        </main>
    {% include 'components/pagination.html' %}
    {% include 'components/footer.html' %}
</body>
<style>



html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    min-height: 100vh;
}
             
.body-base {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
}
        
main {
    display: flex;
    flex-direction: row;
    justify-content: center;
    gap: 20px;
    padding: 20px;
    width: 100%;  
}

.cards{
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    border-radius: 5px;
    border: 3px solid black;
    box-shadow: 4px 4px 8px rgb(46, 46, 209);
    width: 70%;
    min-height: 70vh; 
}
.news-customer-analysis{
    border-radius: 5px;
    border: 3px solid black;
    box-shadow: 4px 4px 8px rgb(46, 46, 209);
    width: 25%;
}

.headers {
    text-align: center;
    font-size: 2.5rem;
    margin: 20px 0;
    color: #333;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}


.pagination{
    width: 100%;
    height: 40px;
    margin-top: 20px;
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    align-content: center;
    justify-content: center;
}
.btn-pagination{
    border: 1px, solid, rgb(228, 226, 226);
    background: linear-gradient(135deg,  #3855d5 0%, #7a2bc9 100%);
    height: 80%;
    color: blanchedalmond;
    cursor: pointer;
    transition: all 0.3s ease;
}
.btn-pagination:hover{
    transform: scale(1.05);
    background: linear-gradient(135deg,  #7a2bc9 0%, #3855d5 100%);
}
.pagination-left-button{
    border-top-left-radius: 20px;
    border-bottom-left-radius: 20px;
    width: 7%;
}
.pagination-right-button{
    border-top-right-radius: 20px;
    border-bottom-right-radius: 20px;
    width: 7%;
}   
.btn-page-number{
    width:3%;
}
.current{
    background: #1da4f2;
}

@media (max-width: 442px ){
    .btn-page-number{
    width:7%;
}
}


.search-header {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 1rem;
    width: 50%;
    height: 40px;
    background: rgba(245, 245, 245, 0.612);
    border: 1px solid black;
    border-radius: 10px;
    text-align: center;
    text-justify: center;
}

.search-form-container {
    max-width: 500px;
    margin: 0 auto;
}

.search-results {
    margin-top: 2rem;
}
.text-muted{
    font-size: 18px;
    }

.text-for-subheader{
    display: flex;
    justify-self: center;
    text-align: justify;
    text-justify: inter-word;
    width: 80%;
    transition: all 0.3s ease;
}
.header-text-for-subheader:hover{
    transform: scale(1.02);
    transition: all 0.3s ease;
}

.headers:hover{
    transition: all 0.3s ease;
    transform: scale(1.03);
    background: #a4b1e8;
}    
.alert {
    align-self: center;
    justify-self: center;
    text-align: center;
    text-justify: center;
    height: auto;
    width: 70%;
    height: 80%;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-top:30px;
    margin-bottom:10px;
}
.button-registration{
    margin: 10px auto;
}

.display-none{
    display: none;
}

</style>



<script>
class LikesAndSavesSystem{

    constructor() {
        this.userLike = new Set();
        this.userSave = new Set();
        this.lengthuserLike = 0 
        this.lengthuserSave= 0 
        this.initialization = false;
    }

    async init(){
        if (this.initialization) return;
        const likes = await LoadUserLikes();
        const saves = await loadSaveCards();
        this.userLike = new Set(likes);
        this.userSave = new Set(saves);
        this.lengthuserLike = this.userLike.size
        this.lengthuserSave = this.userSave.size
        this.initialization = true;
        this.UpdateAllLikesButtons();
        this.UpdateAllSaveButtons();
        this.UpdateNavbarCount();
        this.bindEvents();
        console.log("–¥–∞–Ω–Ω—ã–µ –ª–∞–π–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã ")
    }

    hasLiked(newsId){
        if (this.userLike.has(parseInt(newsId))){
            return true;
        }
        return false;
    }

    hesSaved(newsId){
        if (this.userSave.has(parseInt(newsId))){
            return true;
        }
        return false;
    }

    UpdateNavbarCount(){
        const elementCountLikesAndSaved = document.querySelector(".count-saved-liked-card")
        const elementCountLikes = document.querySelector(".count-like-card")
        const elementCountSaved = document.querySelector(".count-save-card")

        if(this.lengthuserLike + this.lengthuserSave > 0){
            elementCountLikesAndSaved.classList.remove("display-none")
            elementCountLikesAndSaved.innerHTML = `<span>${this.lengthuserLike + this.lengthuserSave}</span>`;
            if (this.lengthuserLike>0){
                elementCountLikes.classList.remove("display-none")
                elementCountLikes.innerHTML = `<span>${this.lengthuserLike}</span>`;
            }else{
                elementCountLikes.classList.add("display-none")
            }
            if (this.lengthuserSave>0){
                elementCountSaved.classList.remove("display-none")
                elementCountSaved.innerHTML = `<span>${this.lengthuserSave}</span>`;
            }else{
                elementCountSaved.classList.add("display-none")
            }
        }else{
            elementCountLikesAndSaved.classList.add("display-none")
        }
    }
    UpdateAllLikesButtons(){
        document.querySelectorAll(".likeBtn").forEach(button =>{
            const newsId = button.dataset.id;
            const isLiked = this.hasLiked(newsId)
            this.UpdateLikeButton(button,isLiked,newsId)
        })
    }

    UpdateLikeButton(button,isLiked,newsId){
        if (isLiked){
            button.classList.add('liked');
            button.innerHTML = `‚ù§Ô∏è <span id="likeCount" class="like-count">${this.getlikeCount(newsId)+1}</span>`;
        }
        else{
            button.classList.remove('liked');
            button.innerHTML = `ü§ç <span id="likeCount" class="like-count">${this.getlikeCount(newsId)-1}</span>`
        }
    }

    UpdateAllSaveButtons(){
        document.querySelectorAll(".btn-save").forEach(button =>{
            const newsId = button.dataset.id;
            const isSaved = this.hesSaved(newsId)
            this.UpdateSaveButtons(button,isSaved,newsId)
        })
    }

    UpdateSaveButtons(botton, isSaved, newsId){
        if (isSaved){
            botton.classList.add("display-none") // –¥–æ–ø–∏—Å–∞—Ç—å —ç—Ç–æ—Ç —Å—Ç–∏–ª—å,—á—Ç–æ–±—ã –±—ã–ª –ø–æ –≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–¥–ª—Å—è—è —Å—Ç–∞—Ç–∏—á–Ω–æ–π –≥–∞–ª–∫–æ–π(–ø–æ–∫–∞ hidden)
        }
        else{
            botton.classList.remove("display-none")
        }
    }

    getlikeCount(newsId){
        const countLike = parseInt(document.querySelector(`[data-id="${newsId}"] .like-count`)?.textContent) || 0
        return countLike
    }

    async changeCount(selector, bool_action){
        let element =  document.querySelector(selector)
        let count = parseInt(element?.textContent) || 0
        if(!bool_action){
            count = count + 1
        }else{
            count = count - 1
        }
        element.textContent = count
    }

    bindEvents(){

        document.addEventListener('click', (e) =>{
            if(e.target.classList.contains('likeBtn')){              
                this.toggleLike(e.target);
            }
            if(e.target.classList.contains('btn-save')){
                this.toggleSave(e.target)
            }
            if(e.target.classList.contains("delete-save")){
                this.toggleDeletSave(e.target)
            }
        })
    }
    
    async toggleDeletSave(button){
        // –¥–æ–¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥–∞—ë—Ç, 
        const news_id = button.dataset.id
        console.log(`${news_id}`)
        try{    
            const respons = await fetch(
                "/api/delet-save-news",{
                    method:"POST",
                    headers:{
                        "Content-Type":"application/json",
                        "X-CSRFToken":getCSRFToken()},
                    body:JSON.stringify({
                        "news_id":news_id
                    })
                }
            )
            if(!respons.ok){
                throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞`)
            }
            const data = await respons.json()
            if(data.status === "success"){
                const news_card = button.closest(".news-card")
                console.log("–∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ")
                news_card?.remove();
            }
        }catch{
            console.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞`)
        }

        //await changeCount(".delete-save", )
    }
    async toggleLike(button){ 
        const isLiked =  button.classList.contains("liked")
        const newsId = button.dataset.id;
        let response; 
        try {
            response = await fetch("/api/news/likes_fro_card", {
                method: "POST", 
                headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken() 
            },
            body: JSON.stringify({
                "id": newsId,
                "isLiked":!isLiked
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.status === "success") {
            this.UpdateLikeButton(button, !isLiked, newsId);
            if (isLiked){
                let listLikes = JSON.parse(localStorage.getItem('userLikes')) || [] 
                listLikes = listLikes.filter(id=> parseInt(id) !== parseInt(newsId));
                localStorage.setItem('userLikes', JSON.stringify(listLikes))
            }else{
                let listLikes = JSON.parse(localStorage.getItem('userLikes')) || []
                listLikes.push(parseInt(newsId))
                localStorage.setItem('userLikes', JSON.stringify(listLikes))
            }
            await this.changeCount(".count-like-card", isLiked);
            await this.changeCount(".count-saved-liked-card", isLiked); 
            console.log("–í—ã –ª–∞–π–∫–Ω—É–ª–∏ –Ω–æ–≤–æ—Å—Ç—å = )");
        } else {
            console.log("–û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", result.error);
        }
        
    } catch(error) {
        console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫ –Ω–∞ –Ω–æ–≤–æ—Å—Ç—å:", error);
    }
}
    async toggleSave(button){
        const newsId = button.dataset.id;
        const isSaved = this.hesSaved(newsId)
        let response;
        try{
           response = await fetch("/api/news/save",
                {
                    method: "POST", 
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken() 
                    },
                    body:JSON.stringify(
                        {
                            "newsId":newsId,
                            "isSaved":!isSaved,
                        }
                    )
                }
           )
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (isSaved){
                button.classList.remove("display-none");
                let listSavedNews =JSON.parse(localStorage.getItem("saved_cards"));
                listSavedNews = listSavedNews.filter(id => parseInt(id) !== parseInt(newsId));
                localStorage.setItem("saved_cards",JSON.stringify(listSavedNews));
            }else{
                button.classList.add("display-none");
                let listSavedNews =JSON.parse(localStorage.getItem("saved_cards"));
                listSavedNews.push(parseInt(newsId));
                localStorage.setItem("saved_cards",JSON.stringify(listSavedNews))};
            await this.changeCount(".count-save-card", isSaved);
            await this.changeCount(".count-saved-liked-card", isSaved);
        }catch{
            console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å")
        }
    }
}

async function LoadUserLikes() {
    const cachedLikes = localStorage.getItem("userLikes")

    if (cachedLikes){
        console.log("–î–∞–Ω–Ω—ã–µ –ø–æ–ª–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –ª–∞–π–∫–∞v —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        return JSON.parse(cachedLikes)
    }
    try{
        const response = await fetch('api/news/like');
        
        if(!response.ok){
            throw new Error("–æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ get –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –≤—ã–¥–∞—á–∏ –ª–∞–π–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
        }
        const data = await response.json();
        localStorage.setItem('userLikes', JSON.stringify(data.likes_id||[]))
        console.log("–æ—à–∏–±–∫–∞ –∑–¥–µ—Å—å")
        return data.likes_id || [];
    }catch{
        consol.log("–≤ LoadUserLIkes –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞");
        return []
    }
}

async function loadSaveCards() {
    const listSaveCard = localStorage.getItem("saved_cards")
    if (listSaveCard){
        return JSON.parse(listSaveCard)
    }
    else{
        try{
            const respons = await fetch("/api/news/save")
            if (respons.ok){
                localStorage.setItem("saved_cards", JSON.stringify(respons.newsIds||[]))
                return JSON.parse(respons.newsIds)
            }else{
                console.log("–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")
                return []
            }
        }catch{
            console.log("–æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞")
        }
    }
    
}

function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
};

const likesSystem = new LikesAndSavesSystem()
  
document.addEventListener('DOMContentLoaded', async function() {
       
    const correntPath = document.location.pathname
    const selectorsNavLink =  document.querySelectorAll('.nav-link')

    selectorsNavLink.forEach(link =>{
        if(link.href.includes(correntPath)){
            link.classList.add('active')
        }
    })
        
    const selectorSearch = document.querySelector('input[name=q]')
    if(selectorSearch){
        document.addEventListener('focus', () => {
            selectorSearch.parentElement.style.transform = 'scale(1.09rem)'
        })
        document.addEventListener('blur', () => {
            selectorSearch.parentElement.style.transform = 'scale(1rem)'
        })
    }

    await likesSystem.init();
})
</script>