<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .news-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .news-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .news-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .news-meta {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        .news-content {
            line-height: 1.8;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .btn-custom {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .comments-section {
            margin-top: 40px;
            border-top: 1px solid #e9ecef;
            padding-top: 30px;
        }
        .comment {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .comment-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        .comment-author {
            font-weight: bold;
            color: #495057;
        }
        .comment-date {
            color: #6c757d;
            font-size: 0.8rem;
        }
        .like-count {
            margin-left: 10px;
            font-weight: bold;
        }
        .btn-like.active {
            background-color: #dc3545;
            color: white;
        }
        .btn-save.active {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="news-container">
        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
        <div class="mb-4">
            <button onclick="history.back()" class="btn btn-outline-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–æ–≤–æ—Å—Ç—è–º
            </button>
        </div>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="news-header">
            <h1 class="display-4">{{ title }}</h1>
            <div class="news-meta">
                <span class="me-3"><strong>–ê–≤—Ç–æ—Ä:</strong> {{ author }}</span>
                <span class="me-3"><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> {{ source }}</span>
                <span class="me-3"><strong>–¢–µ–º–∞:</strong> {{ topic }}</span>
                <span class="me-3"><strong>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</strong> {{ views }}</span>
                <span><strong>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ:</strong> {{ created_at }}</span>
            </div>
        </div>

        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ -->
        {% if image_url %}
        <div class="text-center">
            <img src="{{ image_url }}" alt="{{ title }}" class="news-image">
        </div>
        {% endif %}

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç -->
        <div class="news-content">
            {{ main_text|linebreaks }}
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="action-buttons">
            <button id="likeBtn" class="btn btn-outline-danger btn-custom" onclick="toggleLike()">
                ‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è <span id="likeCount" class="like-count">0</span>
            </button>
            
            <button id="saveBtn" class="btn btn-outline-success btn-custom" onclick="toggleSave()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            
            <button class="btn btn-outline-primary btn-custom" onclick="shareNews()">
                üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
            </button>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div class="comments-section">
            <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
            
            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
            <div class="mb-4">
                <form id="commentForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="commentText" class="form-label">–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                        <textarea class="form-control" id="commentText" rows="3" 
                                  placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                </form>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
            <div id="commentsList">
                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-author">–ê–ª–µ–∫—Å–µ–π –ü–µ—Ç—Ä–æ–≤</span>
                        <span class="comment-date">2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥</span>
                    </div>
                    <p>–û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Å—Ç–∞—Ç—å—è! –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
                </div>
                
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-author">–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞</span>
                        <span class="comment-date">5 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥</span>
                    </div>
                    <p>–•–æ—Ç–µ–ª–æ—Å—å –±—ã –±–æ–ª—å—à–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // –õ–∞–π–∫–∏
        let likesCount = 0;
        let isLiked = false;
        
        function toggleLike() {
            const likeBtn = document.getElementById('likeBtn');
            const likeCount = document.getElementById('likeCount');
            
            if (isLiked) {
                likesCount--;
                likeBtn.classList.remove('active');
                likeBtn.innerHTML = '‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è <span id="likeCount" class="like-count">' + likesCount + '</span>';
            } else {
                likesCount++;
                likeBtn.classList.add('active');
                likeBtn.innerHTML = '‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è <span id="likeCount" class="like-count">' + likesCount + '</span>';
            }
            
            isLiked = !isLiked;
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/api/news/like/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    news_id: getNewsIdFromURL(),
                    action: isLiked ? 'like' : 'unlike'
                })
            });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        let isSaved = false;
        
        function toggleSave() {
            const saveBtn = document.getElementById('saveBtn');
            
            if (isSaved) {
                saveBtn.classList.remove('active');
                saveBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            } else {
                saveBtn.classList.add('active');
                saveBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            }
            
            isSaved = !isSaved;
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/api/news/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    news_id: getNewsIdFromURL(),
                    action: isSaved ? 'save' : 'unsave'
                })
            });
        }

        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
        function shareNews() {
            if (navigator.share) {
                navigator.share({
                    title: '{{ title }}',
                    text: '{{ title }}',
                    url: window.location.href,
                })
                .then(() => console.log('–£—Å–ø–µ—à–Ω—ã–π —à–∞—Ä–∏–Ω–≥'))
                .catch((error) => console.log('–û—à–∏–±–∫–∞ —à–∞—Ä–∏–Ω–≥–∞', error));
            } else {
                // Fallback - –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
                navigator.clipboard.writeText(window.location.href);
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            }
        }

        // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        document.getElementById('commentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const commentText = document.getElementById('commentText').value;
            if (!commentText.trim()) return;
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ —Å–ø–∏—Å–æ–∫
            addCommentToDOM('–í—ã', commentText);
            
            // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
            document.getElementById('commentText').value = '';
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/api/news/comment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    news_id: getNewsIdFromURL(),
                    text: commentText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                }
            });
        });

        function addCommentToDOM(author, text) {
            const commentsList = document.getElementById('commentsList');
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            commentDiv.innerHTML = `
                <div class="comment-header">
                    <span class="comment-author">${author}</span>
                    <span class="comment-date">—Ç–æ–ª—å–∫–æ —á—Ç–æ</span>
                </div>
                <p>${text}</p>
            `;
            commentsList.prepend(commentDiv);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring(10);
                }
            }
            return null;
        }

        function getNewsIdFromURL() {
            // –ü–æ–ª—É—á–∞–µ–º ID –Ω–æ–≤–æ—Å—Ç–∏ –∏–∑ URL
            const path = window.location.pathname;
            const segments = path.split('/');
            return segments[segments.length - 2]; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º URL –≤–∏–¥–∞ /news/123/
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∞–π–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞
            fetch(`/api/news/${getNewsIdFromURL()}/status/`)
                .then(response => response.json())
                .then(data => {
                    if (data.liked) {
                        toggleLike(); // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ª–∞–π–∫
                    }
                    if (data.saved) {
                        toggleSave(); // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                    }
                    document.getElementById('likeCount').textContent = data.likes_count || 0;
                    likesCount = data.likes_count || 0;
                });
        });
    </script>
</body>
</html>